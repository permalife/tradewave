{% extends "tradewave/base.html" %}

{% load staticfiles %}

{% block title %} {{ entity_name }} {% endblock %}

{% block content %}

  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="{% static "js/jquery-ui.min.js" %}"></script>

  <style>

  .chart rect {
    fill: steelblue;
  }

  .chart text {
    fill: white;
    font: 10px sans-serif;
    text-anchor: end;
  }

  </style>

  <section id="intro">
    {% if entity_marketplace %}
      <form method="post" action="{% url 'tradewave:export_data' %}">
        {% csrf_token %}
        <div class="row">
          <div class="left input-left small-6 columns">
            <label for="market_venue">
              Market venue:
            </label>
            <select name="market_venue" class="text" id="market_venue">
              {% for market_venue in market_venues %}
                  <option class="text" value="{{market_venue}}"> {{market_venue}} </option>
              {% endfor %}
            </select>
          </div>

          <div class="left input-right small-6 columns">
            <label for="vendor">
              Vendor:
            </label>
            <select name="vendor" class="text">
              {% for vendor in vendors %}
                  <option class="text" value="{{vendor}}"
                    {% if vendor == "All" %}
                      selected="selected"
                    {% endif %}>
                      {{vendor}}
                  </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="left small-5 columns">
            <label for="market_start_date">
              Start date:
            </label>
            <input required type="text" name="market_start_date" id="market_start_date"/>
          </div>

          <div class="relative small-2 columns">
            <p class="two-margin-top">to</p>
          </div>

          <div class="right small-5 columns">
            <label for="market_end_date">
              End date:
            </label>
            <input required type="text" name="market_end_date" id="market_end_date"/>
          </div>
        </div>

        <div class="row">
          <div class="left small-6 small-centered columns">
            <label for="credit_type">
              Credit type:
            </label>
            <select name="credit_type" class="text" id="credit_type">
              {% for credit_type in credit_types %}
                  <option class="text" value="{{credit_type}}"
                    {% if credit_type == "All" %}
                      selected="selected"
                    {% endif %}>
                      {{credit_type}}
                  </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row half-margin-top one-margin-bottom">
          <input type="submit" class="button" id="button_export_data" value="Export Market Data"/>
          <!--a href="{% url 'tradewave:export_data' %}" class="button button-style1 button-big"> Export Market Data  </a-->
        </div>
      </form>
    {% endif %}

    <div class="row half">
      <div class="12u">
        <p class="style3">
          Your Account Transactions:
        </p>
      </div>
    </div>
    <svg class="chart"></svg>

    <script type="text/javascript">
      $('#market_start_date, #market_end_date').datepicker();
    </script>

    <script>
      // TODO: Make this a reactive select element to allow the user
      // to choose whether to display the dashboard for their personal
      // or entity accounts
      var arraySpentReceivedUrls = [
        "{% url 'tradewave:transactions-spent' account_entity_id %}",
        "{% url 'tradewave:transactions-received' account_entity_id %}"
      ];
      arraySpentReceivedUrls.forEach(function (tr_url) {
        var width = 420,
            barHeight = 20;

        var x = d3.scale.linear()
            .range([0, width]);

        var chart = d3.select(".chart")
            .attr("width", width);

        d3.csv(tr_url, function(error, data) {
          x.domain([0, d3.max(data, function(d) { return Number(d.amount) + 20; })]);
          chart.attr("height", barHeight * data.length);

          var bar = chart.selectAll("g")
              .data(data)
            .enter().append("g")
              .attr("transform", function(d, i) { return "translate(0," + i * barHeight + ")"; });

          bar.append("rect")
              .attr("width", function(d) { return x(d.amount); })
              .attr("height", barHeight - 1)
              .style("fill", function (d) {
                if (Number(d.transact_to) === {{ account_entity_id }}) {
                  console.log(d.transact_to + '=>' + d.transact_from);
                  return "lightsteelblue";
                }
                else {
                  console.log(d.transact_to + '=>' + d.transact_from);
                  return "lightsalmon";
                }
              });

          bar.append("text")
              .attr("x", function(d) { return x(d.amount) + 30; })
              .attr("y", barHeight / 2)
              .attr("dy", ".35em")
              .style("fill", "black")
              .text(function(d) { return d.amount; });
        });

      });

      function type(d) {
        d.amount = +d.amount; // coerce to number
        return d;
      }
    </script>

    <!--script>
      d3.select(".chart")
        .selectAll("div")
        .csv("http://localhost:8000/transaction-logs/entity/spent/2/?before=1468224984&after=1467879384")
        .enter().append("div").
        .style
    </script-->

  </section>
{% endblock %}
